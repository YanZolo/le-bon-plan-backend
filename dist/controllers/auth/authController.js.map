{"version":3,"sources":["../../../src/controllers/auth/authController.ts"],"names":["dotenv","bcrypt","jwt","UserModel","UserNotFound","Exception","config","ACCESS_TOKEN_SECRET","REFRESH_TOKEN_SECRET","process","env","AuthController","handleRegister","req","res","password","username","email","isAdmin","body","hashedPassword","hash","console","log","user","newUser","save","redirect","handleLogin","findOne","compare","accessToken","sign","expiresIn","refreshToken","updateOne","$addToSet","app","set","cookie","httpOnly","handleLogout","maxAge"],"mappings":"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","sourcesContent":["import dotenv from 'dotenv';\r\nimport bcrypt from 'bcrypt';\r\nimport jwt from 'jsonwebtoken';\r\nimport { Response, Request } from 'express';\r\nimport UserModel from '../../models/userModel.js';\r\nimport UserNotFound from '../../errors/UserNotFound.js';\r\nimport Exception from '../../errors/Exception.js';\r\ndotenv.config();\r\n\r\ninterface ProcessEnv {\r\n  [key: string]: string;\r\n}\r\nconst { ACCESS_TOKEN_SECRET, REFRESH_TOKEN_SECRET } = process.env as ProcessEnv;\r\n\r\nexport default class AuthController {\r\n  // on register page\r\n\r\n  async handleRegister(\r\n    req: Request<\r\n      any,\r\n      any,\r\n      { password: string; username: string; email: string; isAdmin?: boolean }\r\n    >,\r\n    res: Response\r\n  ) {\r\n    const { password, username, email, isAdmin } = req.body;\r\n    const hashedPassword = await bcrypt.hash(password, 10);\r\n    console.log('hashedPassword', hashedPassword);\r\n    const user = new UserModel({\r\n      username: username,\r\n      email: email,\r\n      password: hashedPassword,\r\n      isAdmin: isAdmin\r\n    });\r\n    const newUser = await user.save();\r\n    console.log('newUser saved :', newUser);\r\n    res.redirect('/login');\r\n\r\n    return res;\r\n  }\r\n\r\n  async handleLogin(\r\n    req: Request<any, any, { email: string; password: string }>,\r\n    res: Response\r\n  ) {\r\n    console.log('handleLogin() req.body', req.body)\r\n    const { email, password } = req.body;\r\n    const user = await UserModel.findOne({ email });\r\n    if (!user) {\r\n      throw new UserNotFound();\r\n    }\r\n\r\n    console.log('user', user);\r\n    if (await bcrypt.compare(password, user.password)) {\r\n      const accessToken = jwt.sign({ user }, ACCESS_TOKEN_SECRET, {\r\n        expiresIn: '200s'\r\n      }); // fixed secret type error with inteface ProcessEnv\r\n      const refreshToken = jwt.sign({ user }, REFRESH_TOKEN_SECRET);\r\n      console.log('handleLogin() ==> access token ===>', accessToken);\r\n      await UserModel.updateOne(\r\n        { email },\r\n        { $addToSet: { refreshToken: refreshToken } }\r\n      );\r\n      req.app.set(\"username\", user.username)\r\n      res.cookie('access_token', accessToken, {\r\n        httpOnly: true\r\n      });\r\n      console.log('=====');\r\n      res.redirect('/profile')\r\n      return res\r\n      // return {\r\n      //   status: 'LOGGED'\r\n      // };\r\n    }\r\n    throw new Exception(401, 'Not autorized');\r\n  }\r\n\r\n  handleLogout(req: Request, res: Response) {\r\n    res.cookie('access_token', '', { maxAge: 0});\r\n    res.redirect('/login') \r\n    return res\r\n    \r\n  }\r\n}\r\n"],"file":"authController.js"}